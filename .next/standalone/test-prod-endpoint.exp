#!/usr/bin/expect -f

set timeout 60
set host "37.27.54.247"
set user "nirosha_1"
set password "Celorita13jan!!"
set port "22"

spawn ssh -p $port $user@$host

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "yes/no" {
        send "yes\r"
        exp_continue
    }
    "$ " {
        send "cd /var/www/5fcedb5f-4188-4356-a8e9-4f09d37e27af\r"
        expect "$ "
        send "echo '=== Checking for .env files ==='\r"
        expect "$ "
        send "find . -maxdepth 2 -name '.env*' -type f 2>/dev/null\r"
        expect "$ "
        send "echo ''\r"
        expect "$ "
        send "echo '=== Testing production endpoint ==='\r"
        expect "$ "
        send "curl -X POST https://nirosha.org/api/contact -H 'Content-Type: application/json' -H 'Origin: https://nirosha.org' -d '{\"fullName\":\"Test\",\"countryCode\":\"+91\",\"whatsappNumber\":\"1234567890\",\"email\":\"test@test.com\",\"serviceInterested\":[\"Web Development\"],\"comments\":\"Test\"}' 2>&1 | head -20\r"
        expect "$ "
        send "echo ''\r"
        expect "$ "
        send "echo '=== Checking server.js for hardcoded URL ==='\r"
        expect "$ "
        send "cd server && grep -n 'nirosha.org\\|localhost:3000\\|api/contact' server.js | head -10\r"
        expect "$ "
        send "echo ''\r"
        expect "$ "
        send "echo '=== Checking if server.js has CORS or endpoint config ==='\r"
        expect "$ "
        send "grep -n 'allowedOrigins\\|CORS\\|contact' server.js | head -10\r"
        expect "$ "
        send "exit\r"
    }
}

expect eof

